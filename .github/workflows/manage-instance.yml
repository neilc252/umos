name: Manage Instance State

on:
  repository_dispatch:
    types: [manage-instance]

permissions:
  id-token: write # Required for cloud OIDC.
  contents: read  # Required for actions/checkout.

jobs:
  manage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: 'Debug: Show Webhook Payload'
        run: |
          echo "Action: ${{ github.event.client_payload.action }}"
          echo "Instance: ${{ github.event.client_payload.instance_name }}"
          echo "Platform: ${{ github.event.client_payload.platform }}"
          echo "Region/Zone: ${{ github.event.client_payload.region }}"
          echo "Terraform Dir: ${{ github.event.client_payload.terraform_directory }}"

      # --- Cloud Authentication ---
      - name: Authenticate to Google Cloud
        if: github.event.client_payload.platform == 'gcp'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Configure AWS Credentials for IAM Role
        if: github.event.client_payload.platform == 'aws' && github.event.client_payload.aws_role_arn
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ github.event.client_payload.aws_role_arn }}
          aws-region: ${{ github.event.client_payload.region || 'us-east-1' }}

      - name: Configure AWS Credentials for Access Keys
        if: github.event.client_payload.platform == 'aws' && !github.event.client_payload.aws_role_arn
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.client_payload.region || 'us-east-1' }}

      - name: Azure Login with OIDC
        if: github.event.client_payload.platform == 'azure' && github.event.client_payload.azure_auth_type == 'oidc'
        uses: azure/login@v1
        with:
          client-id: ${{ github.event.client_payload.azure_client_id }}
          tenant-id: ${{ github.event.client_payload.azure_tenant_id }}
          subscription-id: ${{ github.event.client_payload.azure_subscription_id }}

      - name: Azure Login with Client Secret
        if: github.event.client_payload.platform == 'azure' && github.event.client_payload.azure_auth_type != 'oidc'
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      # --- Terraform Action (for delete) ---
      - name: Setup Terraform
        if: github.event.client_payload.action == 'delete'
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Destroy
        if: github.event.client_payload.action == 'delete'
        run: |
          terraform -chdir=${{ github.event.client_payload.terraform_directory }} init
          terraform -chdir=${{ github.event.client_payload.terraform_directory }} destroy -auto-approve -no-color

      # --- Cloud CLI Actions (for start/stop) ---
      - name: Start/Stop GCP Instance
        if: github.event.client_payload.platform == 'gcp' && github.event.client_payload.action != 'delete'
        run: |
          gcloud compute instances ${{ github.event.client_payload.action }} ${{ github.event.client_payload.instance_name }} \
            --project=${{ github.event.client_payload.project_id }} \
            --zone=${{ github.event.client_payload.region }} \
            --quiet

      - name: Start/Stop AWS EC2 Instance
        if: github.event.client_payload.platform == 'aws' && github.event.client_payload.action != 'delete'
        run: |
          INSTANCE_IDS=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=${{ github.event.client_payload.instance_name }}" "Name=instance-state-name,Values=pending,running,shutting-down,stopped,stopping" --query 'Reservations[].Instances[].InstanceId' --output text)
          if [ -z "$INSTANCE_IDS" ]; then
            echo "Instance named '${{ github.event.client_payload.instance_name }}' not found."
            exit 1
          fi
          ACTION="${{ github.event.client_payload.action }}"
          aws ec2 ${ACTION}-instances --instance-ids $INSTANCE_IDS

      - name: Start/Stop Azure VM
        if: github.event.client_payload.platform == 'azure' && github.event.client_payload.action != 'delete'
        run: |
          ACTION="${{ github.event.client_payload.action }}"
          if [ "$ACTION" == "start" ]; then
            az vm start --resource-group ${{ github.event.client_payload.resource_group }} --name ${{ github.event.client_payload.instance_name }}
          elif [ "$ACTION" == "stop" ]; then
            az vm deallocate --resource-group ${{ github.event.client_payload.resource_group }} --name ${{ github.event.client_payload.instance_name }}
          fi
