name: Packer Image Build

# This workflow is triggered by the webhook from the web app
on:
  repository_dispatch:
    types: [build-image]

permissions:
  id-token: write # Required to fetch the OIDC token for AWS & Azure authentication.
  contents: read  # Required for actions/checkout.

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Packer
        uses: hashicorp/setup-packer@main

      - name: Authenticate to Google Cloud
        if: github.event.client_payload.platform == 'gcp'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Configure AWS Credentials for IAM Role
        if: github.event.client_payload.platform == 'aws' && github.event.client_payload.aws_role_arn
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ github.event.client_payload.aws_role_arn }}
          aws-region: ${{ github.event.client_payload.aws_region || 'us-east-1' }}

      - name: Configure AWS Credentials for Access Keys
        if: github.event.client_payload.platform == 'aws' && !github.event.client_payload.aws_role_arn
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.client_payload.aws_region || 'us-east-1' }}
      
      - name: Azure Login with OIDC
        if: github.event.client_payload.platform == 'azure' && github.event.client_payload.azure_auth_type == 'oidc'
        uses: azure/login@v1
        with:
          client-id: ${{ github.event.client_payload.azure_client_id }}
          tenant-id: ${{ github.event.client_payload.azure_tenant_id }}
          subscription-id: ${{ github.event.client_payload.azure_subscription_id }}

      - name: Azure Login with Client Secret
        if: github.event.client_payload.platform == 'azure' && github.event.client_payload.azure_auth_type != 'oidc'
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: 'Debug: Show Webhook Payload'
        run: |
          echo "Building image for OS: ${{ github.event.client_payload.image_id }}"
          echo "Platform: ${{ github.event.client_payload.platform }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Template file: ${{ github.event.client_payload.template_file }}"

      - name: 'Build Packer Image'
        env:
          PKR_VAR_gcp_project_id: ${{ secrets.GCP_PROJECT_ID }}
          # These are now only used for the legacy Azure secret method
          PKR_VAR_client_id: ${{ secrets.AZURE_CLIENT_ID }}
          PKR_VAR_client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          PKR_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          PKR_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          export BUILD_ID="${{ github.run_id }}"
          export PLATFORM="${{ github.event.client_payload.platform }}"
          export TEMPLATE_FILE="${{ github.event.client_payload.template_file }}"
          
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "Error: Template file $TEMPLATE_FILE not found in the repository's root directory."
            exit 1
          fi

          packer init "$TEMPLATE_FILE"
          packer build -var "build_id=$BUILD_ID" -var "platform=$PLATFORM" "$TEMPLATE_FILE"
