name: Packer Image Build

# This workflow is triggered by the webhook from the web app
on:
  repository_dispatch:
    types: [build-image]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Packer
        uses: hashicorp/setup-packer@main

      - name: 'Debug: Show Webhook Payload'
        run: |
          echo "Building image for OS: ${{ github.event.client_payload.image_id }}"
          echo "Platform: ${{ github.event.client_payload.platform }}"

      - name: 'Build Packer Image'
        run: |
          # Dynamically construct the template filename from the payload
          TEMPLATE_FILE="${{ github.event.client_payload.image_id }}-${{ github.event.client_payload.platform }}.pkr.hcl"

          echo "Using template file: $TEMPLATE_FILE"
          
          # Check if the required file exists before trying to build
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "Error: Template file $TEMPLATE_FILE not found in repository."
            exit 1
          fi

          # Authenticate with your cloud provider here
          # (e.g., using google-github-actions/auth for GCP)

          # Run packer init and build using the specific template file
          packer init $TEMPLATE_FILE
          packer build $TEMPLATE_FILE
